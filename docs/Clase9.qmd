
---
title: "Clase 8: Introducción a spAbundance y a spOccupancy"
format: html
editor: visual
---

::: panel-tabset

## spAbundance

El paquete spAbundance ajusta modelos univariados (es decir, de una sola especie) y multivariados (es decir, de múltiples especies) de mezcla espacial N, modelos jerárquicos de muestreo de distancia y modelos mixtos generalizados lineales utilizando cadenas de Markov Monte Carlo (MCMC). Los modelos espaciales se ajustan utilizando Procesos Gaussianos de Vecino más Cercano (NNGPs) para facilitar el ajuste del modelo a grandes conjuntos de datos espaciales. spAbundance utiliza una sintaxis análoga a su "paquete hermano" spOccupancy (Doser et al. 2022). A continuación, proporcionamos una introducción muy breve a algunas de las funcionalidades del paquete e ilustramos solo una de las funciones de ajuste del modelo. Para obtener más información, consulta los recursos referenciados al final de esta página y la pestaña "Artículos" en la parte superior de la página.

[spAbundance](https://www.jeffdoser.com/files/spabundance-web/)

En esta clase, vamos a explorar el paquete spAbundance y comparar su implementación con los paquetes Distance y Unmarked.

```{r}
library(spAbundance)
library(tidyverse)
```
Cargar Base de datos

```{r}
CARPUS <- readRDS("data/CARPUSunmarked.rds")
```

Preparar datos para la tabla

```{r}
CARPUS_y <- CARPUS[,12:14]

CARPUS$Type <- factor(CARPUS$Type)

covs <- list(Elevacion = CARPUS[,4],
             Habitat = CARPUS[,3],
             AreaBasal = CARPUS[,5])


CARPUS_covs <- list(y= CARPUS_y, covs = covs)
```

Ajustar modelo

```{r, message=FALSE, warning=FALSE, results='hide'}
out <- abund(formula = ~ 1,
             data = CARPUS_covs,
             n.rep = 3, family = "Poisson",
             n.batch = 300, batch.length = 100)

out1 <- abund(formula = ~ Elevacion,
             data = CARPUS_covs,
             n.rep = 3, family = "Poisson",
             n.batch = 300, batch.length = 100)

out2 <- abund(formula = ~ Habitat ,
             data = CARPUS_covs,
             n.rep = 3, family = "Poisson",
             n.batch = 300, batch.length = 100)

out3 <- abund(formula = ~ AreaBasal,
             data = CARPUS_covs,
             n.rep = 3, family = "Poisson",
             n.batch = 300, batch.length = 100)
```

```{r,}
waicAbund(out)
waicAbund(out1)
waicAbund(out2)
waicAbund(out3)

summary(out3)

# Abundance regression coefficients
plot(out, param = 'beta', density = FALSE)

```

Preparar tabla para graficar

```{r}
AreaBasal <- data.frame(AreaBasal = seq(min(CARPUS$Area_Basal, na.rm = TRUE), 
                                  max(CARPUS$Area_Basal, na.rm = TRUE), 
                                  length.out = 100))

AreaBasal.s <- AreaBasal - mean(CARPUS$Area_Basal, na.rm = TRUE) / 
                   sd(CARPUS$Area_Basal, na.rm = TRUE)


X.0 <- as.matrix(data.frame(intercept = 1, AreaBasal = AreaBasal.s))

out.pred <- predict(out3, X.0, ignore.RE = TRUE)

# Get the lower bound, median, and 95% credible interval
mu.0.quants <- apply(out.pred$mu.0.samples, 2, quantile, 
                     prob = c(0.025, 0.5, 0.975))

mu.plot.dat <- data.frame(mu.med = mu.0.quants[2, ], 
                          mu.low = mu.0.quants[1, ], 
                          mu.high = mu.0.quants[3, ], 
                          AreaBasal = AreaBasal)
```


Graficar modelo

```{r}
ggplot(mu.plot.dat, aes(x = AreaBasal, y = mu.med)) + 
  geom_ribbon(aes(ymin = mu.low, ymax = mu.high), fill = 'lightblue', alpha = 0.5) +
  geom_line() + 
  theme_bw() + 
  labs(x = 'Covariate', y = 'Expected abundance') +
  theme_classic()
```



## spOccupancy

spOccupancy ajusta modelos de ocupación espacial de especies individuales, múltiples especies e integrados utilizando el método de Monte Carlo por cadenas de Markov (MCMC). Los modelos se ajustan utilizando la técnica de aumento de datos Pólya-Gamma. Los modelos espaciales se ajustan utilizando procesos gaussianos o procesos gaussianos de vecinos más cercanos (NNGP) para conjuntos de datos espaciales grandes. El paquete proporciona funcionalidad para la integración de datos de ocupación de múltiples especies individuales utilizando un marco de verosimilitud conjunta. Para modelos de múltiples especies, spOccupancy proporciona funciones para tener en cuenta las correlaciones residuales entre especies en un marco de modelo de distribución de especies conjuntas mientras se tiene en cuenta la detección imperfecta. A partir de la versión 0.4.0, spOccupancy proporciona funciones para modelos de ocupación de especies individuales de múltiples temporadas (es decir, espacio-temporales). A continuación, proporcionamos una introducción muy breve a algunas de las funcionalidades del paquete, e ilustramos solo una de las funciones de ajuste de modelos. Para obtener más información, consulte los recursos referenciados al final de esta página.

![HN Biology Investigation Academy](HN%20Cursos%20publicidad/HN%20Biology%20Inv%20large.jpg)
